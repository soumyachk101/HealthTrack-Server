{% extends 'admin_portal/base_admin.html' %}
{% load static %}

{% block title %}Admin Dashboard | HealthTrack+{% endblock %}
{% block page_title %}Admin Dashboard{% endblock %}

{% block admin_content %}
<div class="admin-dashboard">
    <section class="admin-hero">
        <h2>Welcome to Admin Dashboard</h2>
        <p>Manage users, monitor system activity, and oversee platform operations</p>
    </section>
    
    <section class="admin-stats">
        <div class="row g-4">
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-primary"><i class="fas fa-users"></i></div>
                    <h4>Total Users</h4>
                    <strong>{{ total_users }}</strong>
                    <small>+{{ new_users_this_week }} this week</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-info"><i class="fas fa-user"></i></div>
                    <h4>Patients</h4>
                    <strong>{{ total_patients }}</strong>
                    <small>{% widthratio total_patients total_users 100 %}% of total</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-success"><i class="fas fa-building"></i></div>
                    <h4>Providers</h4>
                    <strong>{{ total_providers }}</strong>
                    <small>Service providers</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-warning"><i class="fas fa-clock"></i></div>
                    <h4>Pending</h4>
                    <strong>{{ pending_approvals }}</strong>
                    <small>Awaiting approval</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-secondary"><i class="fas fa-file-medical"></i></div>
                    <h4>Records</h4>
                    <strong>{{ total_records }}</strong>
                    <small>Health records</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="admin-stat-card">
                    <div class="stat-icon bg-success"><i class="fas fa-check-circle"></i></div>
                    <h4>System</h4>
                    <strong>100%</strong>
                    <small>All operational</small>
                </div>
            </div>
        </div>
    </section>
    
    <section class="admin-section">
        <div class="section-header">
            <h3>Pending Registrations</h3>
            <a href="{% url 'admin_users' %}?type=pending" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover admin-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Email</th>
                        <th>City</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in pending_registrations %}
                    <tr>
                        <td>{{ user.get_full_name|default:user.username }}</td>
                        <td><span class="badge bg-{% if user.user_type == 'patient' %}info{% else %}success{% endif %}">{{ user.get_user_type_display }}</span></td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.city|default:"-" }}</td>
                        <td>{{ user.created_at|date:"d M Y" }}</td>
                        <td><span class="badge bg-warning">Pending</span></td>
                        <td>
                            <div class="action-btns">
                                <a href="{% url 'admin_approve_user' user.id %}" class="btn btn-sm btn-success" title="Approve">
                                    <i class="fas fa-check"></i>
                                </a>
                                <a href="{% url 'admin_user_detail' user.id %}" class="btn btn-sm btn-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'admin_delete_user' user.id %}" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">No pending registrations</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    
    <section class="admin-section">
        <div class="section-header">
            <h3>Recent Activity</h3>
            <div class="filter-buttons">
                <button class="btn btn-sm btn-outline-secondary active">All</button>
                <button class="btn btn-sm btn-outline-secondary">Patients</button>
                <button class="btn btn-sm btn-outline-secondary">Providers</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover admin-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Type</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td>{{ activity.user.get_full_name|default:activity.user.username }}</td>
                        <td><span class="badge bg-{% if activity.user.user_type == 'patient' %}info{% else %}success{% endif %}">{{ activity.user.get_user_type_display }}</span></td>
                        <td>{{ activity.get_action_display }}</td>
                        <td>{{ activity.details|truncatechars:40 }}</td>
                        <td>{{ activity.created_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">No recent activity</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('usersChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Patients', 'Providers', 'Admins'],
                datasets: [{
                    data: [{{ total_patients }}, {{ total_providers }}, {{ total_users|add:"-"|add:total_patients|add:"-"|add:total_providers }}],
                    backgroundColor: ['#17a2b8', '#28a745', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
});
</script>
{% endblock %}
